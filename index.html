<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase API Bridge for n8n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .status {
            padding: 20px 30px; display: flex; justify-content: space-between;
            align-items: center; background: #f8f9fa; border-bottom: 2px solid #e9ecef;
        }
        .status-item { display: flex; align-items: center; gap: 10px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-indicator.connected { background: #28a745; }
        .status-indicator.disconnected { background: #dc3545; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.5;} }
        .content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section h2 { font-size: 1.5em; margin-bottom: 15px; }
        .endpoint-card {
            background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .endpoint-url {
            font-family: 'Courier New', monospace; background: #fff; padding: 12px;
            border-radius: 6px; margin: 10px 0; word-break: break-all; border: 1px solid #dee2e6;
        }
        .method { display:inline-block; padding:4px 12px; border-radius:4px; font-weight:bold; }
        .method.get { background:#d1ecf1; color:#0c5460; }
        .btn {
            background: #667eea; color:white; border:none; padding:10px 20px;
            border-radius:6px; cursor:pointer; transition:.3s;
        }
        .btn:hover { background:#764ba2; transform:translateY(-2px); }
        .response-area {
            background:#2d2d2d; color:#f8f8f2; padding:15px; border-radius:6px;
            max-height:400px; overflow-y:auto; margin-top:10px; display:none;
        }
        .response-area.show { display:block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>üî• Firebase API Bridge</h1></div>

    <div class="status">
        <div class="status-item">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Connecting...</span>
        </div>
        <div class="status-item">
            <span id="dataCount">0 records loaded</span>
        </div>
    </div>

    <div class="content">
        <div class="section">
            <h2>üì° Available API Endpoints</h2>

            <div class="endpoint-card">
                <span class="method get">GET</span> <strong>All Data</strong>
                <div class="endpoint-url" id="endpoint1"></div>
                <button class="btn" onclick="testEndpoint('all')">Test</button>
                <div class="response-area" id="response-all"></div>
            </div>

            <div class="endpoint-card">
                <span class="method get">GET</span> <strong>Routes</strong>
                <div class="endpoint-url" id="endpoint2"></div>
                <button class="btn" onclick="testEndpoint('routes')">Test</button>
                <div class="response-area" id="response-routes"></div>
            </div>

            <div class="endpoint-card">
                <span class="method get">GET</span> <strong>Buses</strong>
                <div class="endpoint-url" id="endpoint3"></div>
                <button class="btn" onclick="testEndpoint('buses')">Test</button>
                <div class="response-area" id="response-buses"></div>
            </div>

            <div class="endpoint-card">
                <span class="method get">GET</span> <strong>Active Drivers</strong>
                <div class="endpoint-url" id="endpoint4"></div>
                <button class="btn" onclick="testEndpoint('activeDrivers')">Test</button>
                <div class="response-area" id="response-activeDrivers"></div>
            </div>

            <div class="endpoint-card">
                <span class="method get">GET</span> <strong>User Tickets</strong>
                <div class="endpoint-url" id="endpoint5"></div>
                <button class="btn" onclick="testEndpoint('userTickets')">Test</button>
                <div class="response-area" id="response-userTickets"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    /** üî• Auto-connect Firebase on page load */
    const firebaseConfig = {
        databaseURL: "https://kmt-final-2a8c1-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let firebaseData = {};

    /** Update UI endpoints */
    const base = window.location.href.split("?")[0];
    document.getElementById("endpoint1").textContent = `${base}?endpoint=all`;
    document.getElementById("endpoint2").textContent = `${base}?endpoint=routes`;
    document.getElementById("endpoint3").textContent = `${base}?endpoint=buses`;
    document.getElementById("endpoint4").textContent = `${base}?endpoint=activeDrivers`;
    document.getElementById("endpoint5").textContent = `${base}?endpoint=userTickets`;

    /** Realtime listener */
    const dbRef = ref(db);
    onValue(dbRef, (snapshot) => {
        firebaseData = snapshot.val() || {};
        updateStatus(true);
        updateDataCount();
        console.log("Realtime data updated", firebaseData);
    }, (err) => {
        updateStatus(false);
        console.error("Firebase error:", err);
    });

    function updateStatus(connected) {
        const indicator = document.getElementById("statusIndicator");
        const text = document.getElementById("statusText");
        if (connected) {
            indicator.className = "status-indicator connected";
            text.textContent = "Connected to Firebase";
        } else {
            indicator.className = "status-indicator disconnected";
            text.textContent = "Disconnected";
        }
    }

    function updateDataCount() {
        const count = Object.keys(firebaseData).length;
        document.getElementById("dataCount").textContent = `${count} collections loaded`;
    }

    /** UI Test Buttons */
    window.testEndpoint = function(endpoint) {
        const div = document.getElementById(`response-${endpoint}`);
        const data = endpoint === "all" ? firebaseData : firebaseData[endpoint] || { error: "No data found" };
        div.textContent = JSON.stringify(data, null, 2);
        div.classList.add("show");
    };

    /** ‚≠ê API MODE: Wait until Firebase loads, then return JSON */
    const params = new URLSearchParams(window.location.search);
    const endpoint = params.get("endpoint");

    if (endpoint) {

        document.body.innerHTML = "<h3 style='color:white;padding:20px;'>‚è≥ Loading realtime data...</h3>";

        let wait = setInterval(() => {
            if (Object.keys(firebaseData).length > 0) {
                clearInterval(wait);

                let responseData;

                if (endpoint === "all") {
                    responseData = firebaseData;
                } else if (firebaseData[endpoint]) {
                    responseData = firebaseData[endpoint];
                } else {
                    responseData = { error: "Endpoint not found" };
                }

                document.body.innerHTML = `<pre>${JSON.stringify(responseData, null, 2)}</pre>`;
            }
        }, 50);
    }
</script>

</body>
</html>
